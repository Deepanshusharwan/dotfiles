(()=>{var __webpack_modules__={"./node_modules/webextension-polyfill/dist/browser-polyfill.js":function(module,exports){var __WEBPACK_AMD_DEFINE_FACTORY__,__WEBPACK_AMD_DEFINE_RESULT__;"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,__WEBPACK_AMD_DEFINE_FACTORY__=function(module){"use strict";if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)module.exports=globalThis.browser;else{const CHROME_SEND_MESSAGE_CALLBACK_NO_RESPONSE_MESSAGE="The message port closed before a response was received.",wrapAPIs=extensionAPIs=>{const apiMetadata={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(0===Object.keys(apiMetadata).length)throw new Error("api-metadata.json has not been included in browser-polyfill");class DefaultWeakMap extends WeakMap{constructor(createItem,items=void 0){super(items),this.createItem=createItem}get(key){return this.has(key)||this.set(key,this.createItem(key)),super.get(key)}}const makeCallback=(promise,metadata)=>(...callbackArgs)=>{extensionAPIs.runtime.lastError?promise.reject(new Error(extensionAPIs.runtime.lastError.message)):metadata.singleCallbackArg||callbackArgs.length<=1&&!1!==metadata.singleCallbackArg?promise.resolve(callbackArgs[0]):promise.resolve(callbackArgs)},pluralizeArguments=numArgs=>1==numArgs?"argument":"arguments",wrapMethod=(target,method,wrapper)=>new Proxy(method,{apply:(targetMethod,thisObj,args)=>wrapper.call(thisObj,target,...args)});let hasOwnProperty=Function.call.bind(Object.prototype.hasOwnProperty);const wrapObject=(target,wrappers={},metadata={})=>{let cache=Object.create(null),handlers={has:(proxyTarget,prop)=>prop in target||prop in cache,get(proxyTarget,prop,receiver){if(prop in cache)return cache[prop];if(!(prop in target))return;let value=target[prop];if("function"==typeof value)if("function"==typeof wrappers[prop])value=wrapMethod(target,target[prop],wrappers[prop]);else if(hasOwnProperty(metadata,prop)){let wrapper=((name,metadata)=>function asyncFunctionWrapper(target,...args){if(args.length<metadata.minArgs)throw new Error(`Expected at least ${metadata.minArgs} ${pluralizeArguments(metadata.minArgs)} for ${name}(), got ${args.length}`);if(args.length>metadata.maxArgs)throw new Error(`Expected at most ${metadata.maxArgs} ${pluralizeArguments(metadata.maxArgs)} for ${name}(), got ${args.length}`);return new Promise(((resolve,reject)=>{if(metadata.fallbackToNoCallback)try{target[name](...args,makeCallback({resolve,reject},metadata))}catch(cbError){console.warn(`${name} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,cbError),target[name](...args),metadata.fallbackToNoCallback=!1,metadata.noCallback=!0,resolve()}else metadata.noCallback?(target[name](...args),resolve()):target[name](...args,makeCallback({resolve,reject},metadata))}))})(prop,metadata[prop]);value=wrapMethod(target,target[prop],wrapper)}else value=value.bind(target);else if("object"==typeof value&&null!==value&&(hasOwnProperty(wrappers,prop)||hasOwnProperty(metadata,prop)))value=wrapObject(value,wrappers[prop],metadata[prop]);else{if(!hasOwnProperty(metadata,"*"))return Object.defineProperty(cache,prop,{configurable:!0,enumerable:!0,get:()=>target[prop],set(value){target[prop]=value}}),value;value=wrapObject(value,wrappers[prop],metadata["*"])}return cache[prop]=value,value},set:(proxyTarget,prop,value,receiver)=>(prop in cache?cache[prop]=value:target[prop]=value,!0),defineProperty:(proxyTarget,prop,desc)=>Reflect.defineProperty(cache,prop,desc),deleteProperty:(proxyTarget,prop)=>Reflect.deleteProperty(cache,prop)},proxyTarget=Object.create(target);return new Proxy(proxyTarget,handlers)},wrapEvent=wrapperMap=>({addListener(target,listener,...args){target.addListener(wrapperMap.get(listener),...args)},hasListener:(target,listener)=>target.hasListener(wrapperMap.get(listener)),removeListener(target,listener){target.removeListener(wrapperMap.get(listener))}}),onRequestFinishedWrappers=new DefaultWeakMap((listener=>"function"!=typeof listener?listener:function onRequestFinished(req){const wrappedReq=wrapObject(req,{},{getContent:{minArgs:0,maxArgs:0}});listener(wrappedReq)})),onMessageWrappers=new DefaultWeakMap((listener=>"function"!=typeof listener?listener:function onMessage(message,sender,sendResponse){let wrappedSendResponse,result,didCallSendResponse=!1,sendResponsePromise=new Promise((resolve=>{wrappedSendResponse=function(response){didCallSendResponse=!0,resolve(response)}}));try{result=listener(message,sender,wrappedSendResponse)}catch(err){result=Promise.reject(err)}const isResultThenable=!0!==result&&((value=result)&&"object"==typeof value&&"function"==typeof value.then);var value;if(!0!==result&&!isResultThenable&&!didCallSendResponse)return!1;return(isResultThenable?result:sendResponsePromise).then((msg=>{sendResponse(msg)}),(error=>{let message;message=error&&(error instanceof Error||"string"==typeof error.message)?error.message:"An unexpected error occurred",sendResponse({__mozWebExtensionPolyfillReject__:!0,message})})).catch((err=>{console.error("Failed to send onMessage rejected reply",err)})),!0})),wrappedSendMessageCallback=({reject,resolve},reply)=>{extensionAPIs.runtime.lastError?extensionAPIs.runtime.lastError.message===CHROME_SEND_MESSAGE_CALLBACK_NO_RESPONSE_MESSAGE?resolve():reject(new Error(extensionAPIs.runtime.lastError.message)):reply&&reply.__mozWebExtensionPolyfillReject__?reject(new Error(reply.message)):resolve(reply)},wrappedSendMessage=(name,metadata,apiNamespaceObj,...args)=>{if(args.length<metadata.minArgs)throw new Error(`Expected at least ${metadata.minArgs} ${pluralizeArguments(metadata.minArgs)} for ${name}(), got ${args.length}`);if(args.length>metadata.maxArgs)throw new Error(`Expected at most ${metadata.maxArgs} ${pluralizeArguments(metadata.maxArgs)} for ${name}(), got ${args.length}`);return new Promise(((resolve,reject)=>{const wrappedCb=wrappedSendMessageCallback.bind(null,{resolve,reject});args.push(wrappedCb),apiNamespaceObj.sendMessage(...args)}))},staticWrappers={devtools:{network:{onRequestFinished:wrapEvent(onRequestFinishedWrappers)}},runtime:{onMessage:wrapEvent(onMessageWrappers),onMessageExternal:wrapEvent(onMessageWrappers),sendMessage:wrappedSendMessage.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:wrappedSendMessage.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},settingMetadata={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return apiMetadata.privacy={network:{"*":settingMetadata},services:{"*":settingMetadata},websites:{"*":settingMetadata}},wrapObject(extensionAPIs,staticWrappers,apiMetadata)};module.exports=wrapAPIs(chrome)}},void 0===(__WEBPACK_AMD_DEFINE_RESULT__=__WEBPACK_AMD_DEFINE_FACTORY__.apply(exports,[module]))||(module.exports=__WEBPACK_AMD_DEFINE_RESULT__)}},__webpack_module_cache__={};function __webpack_require__(moduleId){var cachedModule=__webpack_module_cache__[moduleId];if(void 0!==cachedModule)return cachedModule.exports;var module=__webpack_module_cache__[moduleId]={exports:{}};return __webpack_modules__[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.exports}__webpack_require__.n=module=>{var getter=module&&module.__esModule?()=>module.default:()=>module;return __webpack_require__.d(getter,{a:getter}),getter},__webpack_require__.d=(exports,definition)=>{for(var key in definition)__webpack_require__.o(definition,key)&&!__webpack_require__.o(exports,key)&&Object.defineProperty(exports,key,{enumerable:!0,get:definition[key]})},__webpack_require__.o=(obj,prop)=>Object.prototype.hasOwnProperty.call(obj,prop),(()=>{"use strict";var browser_polyfill=__webpack_require__("./node_modules/webextension-polyfill/dist/browser-polyfill.js"),browser_polyfill_default=__webpack_require__.n(browser_polyfill);const utils_browser_polyfill=browser_polyfill;var __awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};let currentActiveTabId,currentWindowId;function updateCurrentActiveTab(windowId){return __awaiter(this,void 0,void 0,(function*(){const tabs=yield utils_browser_polyfill.tabs.query({active:!0,windowId});tabs[0]&&tabs[0].id&&tabs[0].url&&(currentActiveTabId=tabs[0].id,currentWindowId=windowId,yield ensureContentScriptLoaded(currentActiveTabId),utils_browser_polyfill.runtime.sendMessage({action:"activeTabChanged",tabId:currentActiveTabId,url:tabs[0].url,isValidUrl:isValidUrl(tabs[0].url),isBlankPage:isBlankPage(tabs[0].url)}))}))}function isValidUrl(url){return url.startsWith("http://")||url.startsWith("https://")||url.startsWith("file:///")}function isBlankPage(url){return"about:blank"===url||"chrome://newtab/"===url||"edge://newtab/"===url}var content_script_utils_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};function ensureContentScriptLoaded(tabId){return content_script_utils_awaiter(this,void 0,void 0,(function*(){try{const tab=yield utils_browser_polyfill.tabs.get(tabId);if(!tab.url||!isValidUrl(tab.url))return void console.log(`Skipping content script injection for invalid URL: ${tab.url}`);yield utils_browser_polyfill.tabs.sendMessage(tabId,{action:"ping"})}catch(error){console.log("Content script not loaded, injecting..."),yield utils_browser_polyfill.scripting.executeScript({target:{tabId},files:["content.js"]})}}))}function detectBrowser(){return thisArg=this,_arguments=void 0,generator=function*(){try{if("undefined"==typeof window||!window)return"undefined"!=typeof browser?"firefox":"undefined"!=typeof chrome?"chrome":"other";if(void 0!==window.KAGI)return"orion";const userAgent=navigator.userAgent.toLowerCase();if(userAgent.includes("firefox"))return userAgent.includes("mobile")?"firefox-mobile":"firefox";if(userAgent.indexOf("edg/")>-1)return"edge";if(userAgent.indexOf("chrome")>-1){const nav=navigator;return nav.brave&&(yield nav.brave.isBrave())?"brave":"chrome"}return userAgent.includes("safari")?function isIPad(){return navigator.userAgent.includes("iPad")||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1}()?"ipad-os":userAgent.includes("mobile")||userAgent.includes("iphone")?"mobile-safari":"safari":"other"}catch(error){return console.error("Error detecting browser:",error),"other"}},new((P=void 0)||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}));var thisArg,_arguments,P,generator}function debounce(func,wait){let timeout=null;return function(...args){const context=this;timeout&&clearTimeout(timeout),timeout=setTimeout((()=>func.apply(context,args)),wait)}}var background_awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};let sidePanelOpenWindows=new Set,isHighlighterMode=!1,hasHighlights=!1,isContextMenuCreating=!1,popupPorts={};function sendMessageToPopup(tabId,message){return background_awaiter(this,void 0,void 0,(function*(){if(function isPopupOpen(tabId){return popupPorts.hasOwnProperty(tabId)}(tabId))try{yield popupPorts[tabId].postMessage(message)}catch(error){console.warn(`Error sending message to popup for tab ${tabId}:`,error)}}))}browser_polyfill_default().runtime.onConnect.addListener((port=>{var _a,_b;if("popup"===port.name){const tabId=null===(_b=null===(_a=port.sender)||void 0===_a?void 0:_a.tab)||void 0===_b?void 0:_b.id;tabId&&(popupPorts[tabId]=port,port.onDisconnect.addListener((()=>{delete popupPorts[tabId]})))}})),browser_polyfill_default().action.onClicked.addListener((tab=>{tab.id&&browser_polyfill_default().scripting.executeScript({target:{tabId:tab.id},files:["content.js"]})})),browser_polyfill_default().runtime.onMessage.addListener(((request,sender,sendResponse)=>{var _a;if("object"==typeof request&&null!==request){const typedRequest=request;if("extractContent"===typedRequest.action&&sender.tab&&sender.tab.id)return browser_polyfill_default().tabs.sendMessage(sender.tab.id,request).then(sendResponse),!0;if("ensureContentScriptLoaded"===typedRequest.action&&typedRequest.tabId)return ensureContentScriptLoaded(typedRequest.tabId).then(sendResponse),!0;if("ensureContentScriptLoaded"===typedRequest.action&&(null===(_a=sender.tab)||void 0===_a?void 0:_a.id))return ensureContentScriptLoaded(sender.tab.id).then((()=>{var _a;return sendResponse({tabId:null===(_a=sender.tab)||void 0===_a?void 0:_a.id})})),!0;if("sidePanelOpened"===typedRequest.action&&sender.tab&&sender.tab.windowId&&(sidePanelOpenWindows.add(sender.tab.windowId),updateCurrentActiveTab(sender.tab.windowId)),"sidePanelClosed"===typedRequest.action&&sender.tab&&sender.tab.windowId&&sidePanelOpenWindows.delete(sender.tab.windowId),"highlighterModeChanged"===typedRequest.action&&sender.tab&&void 0!==typedRequest.isActive&&(isHighlighterMode=typedRequest.isActive,sender.tab.id&&sendMessageToPopup(sender.tab.id,{action:"updatePopupHighlighterUI",isActive:isHighlighterMode}),debouncedUpdateContextMenu(sender.tab.id)),"highlightsCleared"===typedRequest.action&&sender.tab&&(hasHighlights=!1,debouncedUpdateContextMenu(sender.tab.id)),"updateHasHighlights"===typedRequest.action&&sender.tab&&void 0!==typedRequest.hasHighlights&&(hasHighlights=typedRequest.hasHighlights,debouncedUpdateContextMenu(sender.tab.id)),"getHighlighterMode"===typedRequest.action){const result=browser_polyfill_default().storage.local.get("isHighlighterMode");sendResponse({isActive:result})}if("toggleHighlighterMode"===typedRequest.action&&typedRequest.tabId&&(toggleHighlighterMode(typedRequest.tabId),sendResponse({success:!0})),"openPopup"===typedRequest.action)return browser_polyfill_default().action.openPopup().then((()=>{sendResponse({success:!0})})).catch((error=>{console.error("Error opening popup in background script:",error),sendResponse({success:!1,error:error instanceof Error?error.message:String(error)})})),!0;if("toggleReaderMode"===typedRequest.action&&typedRequest.tabId)return injectReaderScript(typedRequest.tabId).then((()=>{browser_polyfill_default().tabs.sendMessage(typedRequest.tabId,{action:"toggleReaderMode"}).then(sendResponse)})),!0;if("extractContent"===typedRequest.action||"ensureContentScriptLoaded"===typedRequest.action||"getHighlighterMode"===typedRequest.action||"toggleHighlighterMode"===typedRequest.action)return!0}})),browser_polyfill_default().commands.onCommand.addListener(((command,tab)=>background_awaiter(void 0,void 0,void 0,(function*(){"quick_clip"===command&&browser_polyfill_default().tabs.query({active:!0,currentWindow:!0}).then((tabs=>{var _a;(null===(_a=tabs[0])||void 0===_a?void 0:_a.id)&&(browser_polyfill_default().action.openPopup(),setTimeout((()=>{browser_polyfill_default().runtime.sendMessage({action:"triggerQuickClip"}).catch((error=>console.error("Failed to send quick clip message:",error)))}),500))})),"toggle_highlighter"===command&&tab&&tab.id&&(yield ensureContentScriptLoaded(tab.id),toggleHighlighterMode(tab.id)),"copy_to_clipboard"===command&&tab&&tab.id&&(yield browser_polyfill_default().tabs.sendMessage(tab.id,{action:"copyToClipboard"})),"toggle_reader"===command&&tab&&tab.id&&(yield ensureContentScriptLoaded(tab.id),yield injectReaderScript(tab.id),yield browser_polyfill_default().tabs.sendMessage(tab.id,{action:"toggleReaderMode"}))}))));const debouncedUpdateContextMenu=debounce((tabId=>background_awaiter(void 0,void 0,void 0,(function*(){if(!isContextMenuCreating){isContextMenuCreating=!0;try{yield browser_polyfill_default().contextMenus.removeAll();const menuItems=[{id:"open-obsidian-clipper",title:"Save this page",contexts:["page","selection","image","video","audio"]},{id:isHighlighterMode?"exit-highlighter":"enter-highlighter",title:isHighlighterMode?"Exit highlighter":"Highlight this page",contexts:["page","image","video","audio"]},{id:"highlight-selection",title:"Add to highlights",contexts:["selection"]},{id:"highlight-element",title:"Add to highlights",contexts:["image","video","audio"]}];"chrome"===(yield detectBrowser())&&menuItems.push({id:"open-side-panel",title:"Open side panel",contexts:["page","selection"]});for(const item of menuItems)yield browser_polyfill_default().contextMenus.create(item)}catch(error){console.error("Error updating context menu:",error)}finally{isContextMenuCreating=!1}}}))),100);browser_polyfill_default().contextMenus.onClicked.addListener(((info,tab)=>background_awaiter(void 0,void 0,void 0,(function*(){"open-obsidian-clipper"===info.menuItemId?browser_polyfill_default().action.openPopup():"enter-highlighter"===info.menuItemId&&tab&&tab.id?yield setHighlighterMode(tab.id,!0):"exit-highlighter"===info.menuItemId&&tab&&tab.id?yield setHighlighterMode(tab.id,!1):"highlight-selection"===info.menuItemId&&tab&&tab.id?yield function highlightSelection(tabId,info){return background_awaiter(this,void 0,void 0,(function*(){isHighlighterMode=!0;const highlightData={id:Date.now().toString(),type:"text",content:info.selectionText||""};yield browser_polyfill_default().tabs.sendMessage(tabId,{action:"highlightSelection",isActive:isHighlighterMode,highlightData}),hasHighlights=!0,debouncedUpdateContextMenu(tabId)}))}(tab.id,info):"highlight-element"===info.menuItemId&&tab&&tab.id?yield function highlightElement(tabId,info){return background_awaiter(this,void 0,void 0,(function*(){isHighlighterMode=!0,yield browser_polyfill_default().tabs.sendMessage(tabId,{action:"highlightElement",isActive:isHighlighterMode,targetElementInfo:{mediaType:"image"===info.mediaType?"img":info.mediaType,srcUrl:info.srcUrl,pageUrl:info.pageUrl}}),hasHighlights=!0,debouncedUpdateContextMenu(tabId)}))}(tab.id,info):"open-side-panel"===info.menuItemId&&tab&&tab.id&&tab.windowId&&(chrome.sidePanel.open({tabId:tab.id}),sidePanelOpenWindows.add(tab.windowId),yield ensureContentScriptLoaded(tab.id))})))),browser_polyfill_default().runtime.onInstalled.addListener((()=>{debouncedUpdateContextMenu(-1)}));const debouncedPaintHighlights=debounce((tabId=>background_awaiter(void 0,void 0,void 0,(function*(){yield setHighlighterMode(tabId,!1),yield function paintHighlights(tabId){return background_awaiter(this,void 0,void 0,(function*(){try{const tab=yield browser_polyfill_default().tabs.get(tabId);if(!tab||!tab.url||!isValidUrl(tab.url)||isBlankPage(tab.url))return;yield ensureContentScriptLoaded(tabId),yield browser_polyfill_default().tabs.sendMessage(tabId,{action:"paintHighlights"})}catch(error){console.error("Error painting highlights:",error)}}))}(tabId)}))),250);function handleTabChange(activeInfo){return background_awaiter(this,void 0,void 0,(function*(){activeInfo.windowId&&(yield function isSidePanelOpen(windowId){return background_awaiter(this,void 0,void 0,(function*(){return sidePanelOpenWindows.has(windowId)}))}(activeInfo.windowId))&&(updateCurrentActiveTab(activeInfo.windowId),yield debouncedPaintHighlights(activeInfo.tabId))}))}function setHighlighterMode(tabId,activate){return background_awaiter(this,void 0,void 0,(function*(){try{const tab=yield browser_polyfill_default().tabs.get(tabId);if(!tab||!tab.url)return;if(!isValidUrl(tab.url)||isBlankPage(tab.url))return;yield ensureContentScriptLoaded(tabId),isHighlighterMode=activate,yield browser_polyfill_default().storage.local.set({isHighlighterMode:activate}),yield browser_polyfill_default().tabs.sendMessage(tabId,{action:"setHighlighterMode",isActive:activate}),debouncedUpdateContextMenu(tabId),yield sendMessageToPopup(tabId,{action:"updatePopupHighlighterUI",isActive:activate})}catch(error){console.error("Error setting highlighter mode:",error),isHighlighterMode=!1,yield browser_polyfill_default().storage.local.set({isHighlighterMode:!1}),debouncedUpdateContextMenu(tabId),yield sendMessageToPopup(tabId,{action:"updatePopupHighlighterUI",isActive:!1})}}))}function toggleHighlighterMode(tabId){return background_awaiter(this,void 0,void 0,(function*(){try{const newMode=!(yield browser_polyfill_default().storage.local.get("isHighlighterMode")).isHighlighterMode;yield browser_polyfill_default().storage.local.set({isHighlighterMode:newMode}),yield browser_polyfill_default().tabs.sendMessage(tabId,{action:"setHighlighterMode",isActive:newMode}),debouncedUpdateContextMenu(tabId),yield sendMessageToPopup(tabId,{action:"updatePopupHighlighterUI",isActive:newMode})}catch(error){console.error("Error toggling highlighter mode:",error)}}))}function injectReaderScript(tabId){return background_awaiter(this,void 0,void 0,(function*(){try{return yield browser_polyfill_default().scripting.insertCSS({target:{tabId},files:["reader.css"]}),yield browser_polyfill_default().scripting.executeScript({target:{tabId},files:["browser-polyfill.min.js"]}),yield browser_polyfill_default().scripting.executeScript({target:{tabId},files:["reader-script.js"]}),!0}catch(error){return console.error("Error injecting reader script:",error),!1}}))}(function initialize(){return background_awaiter(this,void 0,void 0,(function*(){var _a;try{const result=yield browser_polyfill_default().storage.local.get("isHighlighterMode");isHighlighterMode=null!==(_a=result.isHighlighterMode)&&void 0!==_a&&_a,yield function setupTabListeners(){return background_awaiter(this,void 0,void 0,(function*(){const browserType=yield detectBrowser();["chrome","brave","edge"].includes(browserType)&&(browser_polyfill_default().tabs.onActivated.addListener(handleTabChange),browser_polyfill_default().tabs.onUpdated.addListener(((tabId,changeInfo,tab)=>{"complete"===changeInfo.status&&handleTabChange({tabId,windowId:tab.windowId})})))}))}(),yield debouncedUpdateContextMenu(-1),console.log("Background script initialized successfully")}catch(error){console.error("Error initializing background script:",error)}}))})().catch((error=>{console.error("Failed to initialize background script:",error)}))})()})();